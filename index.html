
<!-- HTML generated by smallblog <https://github.com/abyxcos/smallblog> -->
<!DOCTYPE html>
<html>
	<head>
		<title>blog</title>
		<link rel="stylesheet" href="/blog/main.css">
		<link rel="stylesheet" href="main.css">
	</head>
	<body>
		<div class="container">
			<div class="site">
				<div class="header">
					<h1 class="title"><a href="/blog">mnetic.ch/blog</a></h1>
					<a class="extra" href="/blog/tags/">tags</a>
					<a class="extra" href="/blog/archive.html">all posts</a>
					<a class="extra" href="/blog/feed.rss">rss</a>
				</div>

		<h2 class="title"><a href='/blog/2014/06/14/rxvt_terminfo_on_smartos.md.html'>
		How to make your server happy while using rxvt
		</a></h2>
		<p class="meta">Date: 2014-06-14 16:49:36 +0000</p>
		<div class="post">
<p>This one is for all of you <a href="http://en.wikipedia.org/wiki/Rxvt-unicode">rxvt</a> fans out there. I&rsquo;m sure many a time you have logged into some strange or new machine and been greeted by</p>

<pre><code>$ tmux
open terminal failed: missing or unsuitable terminal: rxvt-unicode-256color
</code></pre>

<p>And I&rsquo;m sure just as many of you have solved it with a quick</p>

<pre><code>$ export TERM=xterm
</code></pre>

<p>and been on your way. I finally got tired of this and decided to fix it. This post is targeted at <a href="http://smartos.org/">SmartOS</a>, as it&rsquo;s use of a segregated <a href="http://www.pkgsrc.org/">pkgsrc</a> userland is fairly unique, although shared by <a href="http://brew.sh/">Mac OSX</a>. These missing terminal definitions also occur on Debian and <a href="http://mail-index.netbsd.org/netbsd-users/2014/05/31/msg014665.html">NetBSD</a>.</p>

<p>This problem occurs when you install a new terminal emulator to your local computer, now your servers don&rsquo;t know what capabilities it has. Servers have a much smaller database of popular terminals that generally includes xterm, but not rxvt and friends. If your server already has X installed, you can simply install your favorite terminal there and benefit from pre-packaged terminfo files. Most servers don&rsquo;t have X installed so we need to inform our server about our new terminal.</p>

<p>Unfortunately, terminfo entries are stored as binary, so we need to decompile them before passing them over to the server. On your host machine, <a href="http://linux.die.net/man/1/infocmp"><code>infocmp(1)</code></a> will handle this. If, like me, you only care about a single entry, <code>rxvt-unicode-256color</code>, then</p>

<pre><code>$ infocmp -I rxvt-unicode-256color &gt; rxvt-unicode-256color.terminfo
</code></pre>

<p>and <a href="http://linux.die.net/man/1/scp"><code>scp(1)</code></a>ing the resulting file to your server will do the trick. If you want more, just continue feeding <a href="http://linux.die.net/man/1/infocmp"><code>infocmp(1)</code></a> more names. If you&rsquo;re not sure of the exact names, the terminfo files are likely located under <code>/usr/share/terminfo/*/*</code> alphabetically on a Linux machine.</p>

<p>Now we need to compile and install the file on our server. On Linux and BSD, this is simple and handled by <a href="http://linux.die.net/man/1/tic"><code>tic(1)</code></a>. To install for all users,</p>

<pre><code>$ sudo tic -s rxvt-unicode-256color.terminfo
</code></pre>

<p>or for just the local user,</p>

<pre><code>$ tic -s -o ~/.terminfo rxvt-unicode-256color.terminfo
</code></pre>

<p>If your terminfo files still aren&rsquo;t being found, you may need to set <code>$TERMINFO</code> to point to the installed path,</p>

<pre><code>$ export TERMINFO=~/.terminfo
</code></pre>

<p>SmartOS is a bit more complicated, due to the separate userlands. There are two <code>tic(1m)</code>&rsquo;s, the system <code>tic(1m)</code> at <code>/usr/bin/tic</code>, and the pkgsrc <code>tic(1m)</code> at <code>/opt/local/bin/tic</code>. I was not able to locate the man pages online, but you may note the difference in</p>

<pre><code>$ MANPATH=/usr/man man -s 1m tic # system manpages
$ MANPATH=/opt/local/man man -s 1 tic # pkgsrc manpages
</code></pre>

<p>If you <a href="http://www.illumos.org/man/1/ldd"><code>ldd(1)</code></a> the pkgsrc tmux,</p>

<pre><code>$ ldd /opt/local/bin/tmux
</code></pre>

<p>and look for curses, you will see that it&rsquo;s linked against <code>libcurses.so.1</code>, which is living in <code>/lib</code>. This means that <code>tmux</code> will default to looking in the system directory, <code>/usr/share/lib/terminfo</code>, which on SmartOS is read only. In this case, you <em>will</em> need to set <code>$TERMINFO</code> to ensure that your path is being found, as the system <code>tic(1m)</code> doesn&rsquo;t include <code>~/.terminfo</code> in it&rsquo;s default path like linux does. For a system install,</p>

<pre><code>$ sudo /opt/local/bin/tic -s rxvt-unicode-256color.terminfo
$ export TERMINFO=/opt/local/share/lib/terminfo
</code></pre>

<p>or a local install,</p>

<pre><code>$ tic -s -o ~/.terminfo rxvt-unicode-256color.terminfo
$ export TERMINFO=~/.terminfo
</code></pre>

<p>and now <code>tmux</code> should work.</p>

<p class="meta">tags: rxvt smartos solaris bsd linux tmux</p>
<br /></div>

		<h2 class="title"><a href='/blog/2013/08/18/smallblog_howto_part_2.md.html'>
		How to create a static blog in shell (part 2)
		</a></h2>
		<p class="meta">Date: 2013-08-20 22:50:28 +0000</p>
		<div class="post">
<p>Continued from <a href="http://mnetic.ch/blog/2013/08/17/smallblog_howto.md.html">part 1</a>.</p>

<p>In this second section, we&rsquo;ll talk about creating a way to list previous posts, portability fixes, and cleaning up the code. Yup, our current code is hardly pretty. And I assume that most of the programmers reading this have been a bit bothered. While our very first iteration was elegant in it&rsquo;s simplicity (being a one-lined pipe,) it quickly got hackish once we needed to add loops. And if you looked through the commits I linked, you&rsquo;ll notice that it gets worse and worse with escapes, and pipes everywhere. Something must be able to be optimized here.</p>

<p>Well, this was on purpose. Recently, on <a href="https://news.ycombinator.com/">Hacker News</a> there has been a short but intense burst of articles about &ldquo;getting things done&rdquo; and &ldquo;just doing it.&rdquo; I&rsquo;ve been trying to create a personal website for way too many years now. It&rsquo;s never been a technical problem that stopped me, rather the small things. PHP came around, and it was cool to throw up small personal websites, but I never had anything to write about. Then frames and tables were going out of style in favor of convoluted CSS layouts, and PHP was going to die any day now. So I jumped on the python bandwagon, but now I had nothing to write about again. Then another year of wanting to write, but not having a site, followed by a few more years of having a wordpress blog, but hating the software and theme, and being worried that it would get hacked, taking down the rest of the projects on my server. In the last month I finally got external validation that people were actually interested in reading some of my posts, after getting a lot of interest in the hoops I jumped through to get a working root <a href="http://zfsonlinux.org/">ZFS</a> filesystem on Debian Linux. Now that I had things to write about, I needed a place to write them. I decided to write about creating a blog as I created the blog, finally solving everyone&rsquo;s favorite circular dependency.</p>

<p>As you can see from the previous <a href="http://mnetic.ch/blog/2013/08/17/smallblog_howto.md.html">post</a> and my commits, this code very much embodies the <a href="http://en.wikipedia.org/wiki/Minimum_viable_product">MVP</a> principle. The core feature of this software is a single line pipe, surrounded by a few <code>echo</code>s, and it grew outwards from that single line. This has the benefit over the top-down approach in that your program always works, and you&rsquo;re only adding features to it. Taking the top-down approach can easily lead to trying to make everything work at once, and attempting to add features to a core that still isn&rsquo;t functioning. So, let&rsquo;s add some features to our core.</p>

<h1>Shell functions</h1>

<p>Yup, shell has functions. And they&rsquo;ll let us stave off some of this uglyness we&rsquo;re getting from piping every line to index.html. So let&rsquo;s take our previous example, and pull out the core of that for loop into a function. Previously, we had this:</p>

<pre><code>$ cat smallblog
for post in `ls -r */*/*/*.md`; do
    echo "&lt;p&gt;&lt;div class=\"post\"&gt;" &gt;&gt; index.html
    markdown "${post}" &gt;&gt; index.html
    echo "&lt;/div&gt;&lt;/p&gt;" &gt;&gt; index.html
done
</code></pre>

<p>The inside of this loop is the important part, and we want to pull out all those pipes to index.html. So, let&rsquo;s go with something like this:</p>

<pre><code>$ cat smallblog
prepare_post(){
    echo "&lt;p&gt;&lt;div class=\"post\"&gt;"
    markdown "$1"
    echo "&lt;/div&gt;&lt;/p&gt;"
}

for post in `ls -r */*/*/*.md`; do
    prepare_post "${post}" &gt;&gt; index.html
done
</code></pre>

<p>Much cleaner now, right? Clean enough that we could even re-use this to generate individual .html pages we could link to for each post. Let&rsquo;s rewrite a bit that for loop, and set a variable up top to cap the maximum number of posts that can be on the front page at once.</p>

<pre><code>$ tail smallblog
max_posts=5

for post in `ls -r */*/*/*.md`; do
    prepare_post "${post}" &gt; "${post}.html"
    if [ ${max_posts} -gt 0 ]; then
        prepare_post "${post}" &gt;&gt; index.html
        max_posts'`expr ${max_posts} -1`
    fi
done 
</code></pre>

<p>Hardly as clean as a <code>if(max_posts--)</code>, but not every language can be C. With our new loop, we now have a bunch of abandoned files buried in our date folders, but no one else knows this. So let&rsquo;s link to them.</p>

<pre><code>$ head smallblog
prepare_post(){
    echo "&lt;h2 class=\"title\"&gt;&lt;a href='/blog/$1.html'&gt;
        `head -n1 $1 | sed 's/^#* //'`
        &lt;/a&gt;&lt;/h2&gt;
        &lt;p class=\"meta\"&gt;Date: $2&lt;/p&gt;
        &lt;div class=\"post\"&gt;"
    markdown "$1"
    echo "&lt;/div&gt;"
}

for post in `ls -r */*/*/*.md`; do
    time=`stat -c %y ${post} | sed 's/\..* / /'`
    prepare_post "${post}" "${time}" &gt;&gt; index.html
done
</code></pre>

<p>I&rsquo;ll explain those two regexes for everyone. The first one in the header, <code>head -n1 $1 | sed 's/^#* //'</code> grabs the first line of your markdown post, and strips the pound signs off of it, leaving you with the plain title for your link text. The second one, <code>stat -c %y ${post} | sed 's/\..* / /'</code> grabs the last modified timestamp from <a href="http://linux.die.net/man/1/stat"><code>stat(1)</code></a> and strips off the miliseconds from the time, giving us a nice time and dateto put on the post. For those of you who aren&rsquo;t interested in including the timezone on the post, you can pipe it through an additional regex to strip that bit off, such as <code>| sed 's/ [+-].*$//'</code>.</p>

<h2>Portability?</h2>

<p>A few of you that have been following along are now scratching your heads; that last example is giving me an error. Why did this happen, there haven&rsquo;t been any typos in the post so far? A few of you may have even checked the <a href="https://github.com/abyxcos/smallblog/blob/5f4c320f1d96226239271db5092e038948a4c18b/smallblog#L57">code</a>. Congratulations, you are most likely the owner of a Macbook. If you&rsquo;re more lucky, you may even be running <a href="http://www.openbsd.org/">OpenBSD</a>. But the most likely cause of this is that you are running a BSD userland. One of the better things Apple has done for the world is include a BSD userland with their operating system (based on FreeBSD, but with a GNU toolchain.) This has caused a large amount of pain to many Linux developers, as they&rsquo;ve now realized that their portable unix software isn&rsquo;t really that portable at all. In fact, most of it&rsquo;s highly Linux specific. This isn&rsquo;t entirely their fault, the GNU foundation has been pushing the GNU is not Unix motto for a bit, and many GNU and Linux tools have diverged a bit from the standards, for better or worse. This leads to such things as the wildly different <code>stat(1)</code> options you are now seeing. The man pages listing the options of each <code>stat(1)</code> as follows:</p>

<ul>
<li><a href="http://linux.die.net/man/1/stat">Linux</a></li>
<li><a href="https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man1/stat.1.html">Mac OSX</a></li>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=stat&amp;sektion=1">OpenBSD</a></li>
</ul>


<p>As you can see, OSX uses the BSD version of <code>stat(1)</code>, both of which differ from the current Linux implementation. I am currently developing on a Linux computer, so I didn&rsquo;t notice this right away (I&rsquo;m not a heavy user of <code>stat(1)</code>,) but I felt it made for a good example. Another highly divergent utility is <code>ls(1)</code>. But now, for all of you BSD folks, the <code>stat(1)</code> line you&rsquo;re looking for is <code>stat -f "%Y-%m-%d %H:%M:%S %z" "${post}"</code>. This is included in the latest version of <a href="https://github.com/abyxcos/smallblog">smallblog</a> so you can switch out the Linux line for the BSD line as required. I&rsquo;m currently looking for a more portable method of finding the file modification time. If you know a good one, send over a pull request.</p>

<h2>And now we return to your original programming</h2>

<p>Now that we&rsquo;re all portable, let&rsquo;s get back to the original problem we set aside; how can people find all our old posts? The few newest ones will show up on the main page, but we need some method to index them so we can go back to older articles. Well, MVP to the rescue.</p>

<pre><code>$ head smallblog
make_archive(){
    for post in `ls -r */*/*/*.md`; do
        echo "&lt;li&gt;&lt;span&gt;${time}&lt;/span&gt; &amp;raquo;
            &lt;a href=\"/blog/$1.html\"&gt;$2&lt;/a&gt;&lt;/li&gt;"
    done
}
</code></pre>

<p>We can use the same exact trick we used for the post title to pass a title to <code>make_archive</code>. Now we can just drop this right after the main loop like so:</p>

<pre><code>$ tail smallblog
make_archive "${post}" "`head -n1 "${post}" | sed 's/#* //'`" &gt; archive.html
</code></pre>

<p>Now, all we need to do is link this new page to the main page.</p>

<h2>To top it all off</h2>

<p>Wait a minute, wasn&rsquo;t our main page a bit&hellip; lacking? In fact, I don&rsquo;t even think it&rsquo;s valid html. I recall learning something about a <code>&lt;head&gt;</code> and <code>&lt;body&gt;</code> tag in school&hellip;</p>

<p>Turns out this is really easy to fix. All we need to do is <code>echo</code> a bit of html before and after our for loop. If you&rsquo;re also using the <a href="https://github.com/mojombo/jekyll/blob/master/lib/site_template/css/main.css">jekyll theme</a>, this bit of html is really easy.</p>

<pre><code>blog_header="
    &lt;html&gt;&lt;body&gt;&lt;div class=\"site\"&gt;
    &lt;div class=\"header\"&gt;
        &lt;h1 class=\"title\"&gt;&lt;a href=\"/blog\"&gt;mnetic.ch/blog&lt;/a&gt;&lt;/h1&gt;
        &lt;a class=\"extra\" href=\"/blog/archive.html\"&gt;all posts&lt;/a&gt;
    &lt;/div&gt;"
blog_footer="&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;"
</code></pre>

<p>As a bonus, by using variables instead of <code>echo</code> here, we can <code>echo</code> these variables in front of the line that generates the individual files, allowing one to make their way back to our home page from a post, with no effort on our part, or theirs.</p>

<h2>Where to next?</h2>

<p>We&rsquo;ve picked off most of the easy code clean-ups now, but there&rsquo;s still plenty to go. In fact, that last bit of <code>echo</code>ing left us with two lines of code duplication that we can definitely factor out. And we haven&rsquo;t even found an elegant way to split up our post archive by months, rather than one ever-growing list. But, we did it. We now have a perfectly working blog, and no more excuses to not write while we hack away at it. So happy writing, and godspeed.</p>

<p>The code up to here roughly corresponds to <a href="https://github.com/abyxcos/smallblog/blob/4bc0b609f963f0a7f754716720d6ff0d4b25fc7a/smallblog">this</a> commit in smallblog. All of the code in the examples is free to use, you may hack it up in any way you want. The full <a href="https://github.com/abyxcos/smallblog">program</a> is released under the <a href="https://github.com/abyxcos/smallblog/blob/master/LICENSE">ISC license</a>, so feel free to fork it, use it as is, or send patches back my way. My next goals with smallblog are to round of BSD compatibility, and work out some way to add and sort posts by tags without any server side scripting (symlinks are looking mighty good here.) These will be covered in <a href="#">part 3</a>.</p>

<p class="meta">tags: smallblog shell bash</p>
<br /></div>

		<h2 class="title"><a href='/blog/2013/08/17/smallblog_howto.md.html'>
		How to create a static blog in shell (part 1)
		</a></h2>
		<p class="meta">Date: 2013-08-20 22:50:11 +0000</p>
		<div class="post">
<p>This is a short description of the process I went about to create <a href="https://github.com/abyxcos/smallblog">smallblog</a>. If you&rsquo;re reading this, you&rsquo;ve most likely heard of <a href="http://jekyllrb.com/">jekyll</a>. If you haven&rsquo;t heard of jekyll, it&rsquo;s a small ruby script to create a static set of pages out of markdown files, and link them all together with a simple index. No server-side language, so it&rsquo;s both <a href="http://nginx.org/">nginx</a> friendly, and <a href="https://news.ycombinator.com/">Hacker News</a> friendly. No more worries about caching plugins, or if your database is optimized for traffic. And no chance of updates breaking your site. Of course the downside is you must regenerate your whole blog every time you update a post.</p>

<p>As you&rsquo;re still here, you probably weren&rsquo;t interested in adding ruby to your setup for jekyll, and none of the python counterparts interested you. Or you found an engine you liked, but the theme was downright depressing. And now you&rsquo;ve decided to make your own, but you&rsquo;re not sure where to start. Well, let me help you out.</p>

<h2>Step 1</h2>

<p>Find a theme you like. No really. If you go down the path of trying to create one (again,) wire-framing things up, you&rsquo;ll probably give up (again.) I picked the <a href="https://github.com/mojombo/jekyll/blob/master/lib/site_template/css/main.css">jekyll theme</a>, which is the one currently in use here. Contrary to how they dressed up their site, the theme is nice and clean, and very simple. It&rsquo;s also easy to modify, and the kind folks over there released it under an MIT license. Now that you&rsquo;ve picked a theme you like, it&rsquo;s trivial to modify the output of your script to line up the div classes with your new theme.</p>

<h2>Wait, what script?</h2>

<p>See, picking a theme is so easy that you already forgot you didn&rsquo;t have a script. So, let&rsquo;s make a script.</p>

<pre><code>$ cat smallblog
markdown */*/*/*.md &gt; index.html
</code></pre>

<p>Seems easy enough. Now let&rsquo;s expand it a bit. We can store markdown files for each post in <code>year/month/day/</code>, and iterate over them. But it would be really nice if we had some way to visually separate posts, instead of just scanning the page for h1s. Let&rsquo;s spit out a header before each post so we can have a title, and even a date string.</p>

<pre><code>$ cat smallblog
for post in `ls -r */*/*/*.md`; do
    echo "&lt;p&gt;&lt;div class=\"post\"&gt;" &gt;&gt; index.html
    markdown "${post}" &gt;&gt; index.html
    echo "&lt;/div&gt;&lt;/p&gt;" &gt;&gt; index.html
done
</code></pre>

<p>Hardly the most pretty script, but it&rsquo;s starting to look quite like a blog. The div class <code>post</code> plugs directly into jekyll&rsquo;s theme. If you&rsquo;re using a different theme, alter the html slightly so it all lines up. Now let&rsquo;s let our programmer sensibilities take over, and pretty this up into a real program. While we&rsquo;re at it, we can make it a bit more robust. This is left as an exercise to the reader. <a href="https://github.com/abyxcos/smallblog/blob/0ceabeaa5cf5a04247a03d930b481c257ce658e3/smallblog">Here</a> is the initial code I created to print out the blog. This shows evidence of an unfortunate habit I picked up from another language that doesn&rsquo;t support regexes. The next step is to pull out code that actually generates the post and it&rsquo;s headers into a function so it can be called both individually (to create stand-alone post that can be linked to,) and in the main loop to populate the front page. There is some extra logic to limit the number of posts that appear on the front page, as it may get rather crowded once it&rsquo;s in use. <a href="https://github.com/abyxcos/smallblog/blob/5f4c320f1d96226239271db5092e038948a4c18b/smallblog">Here</a> is the final code from today that removes the for loops, and replaces them with the wildcard regex from this article.</p>

<h2>What next?</h2>

<p>Congratulations, we now have a serviceable blog. As we let the dust settle, now we realize that we&rsquo;re lacking any means of navigation beyond scrolling through the latest set of articles on the main page. So we need some kind of index of all the posts in the blog. As seen, we can easily generate a list of files with <code>ls</code>, and we can exploit our datefull directory structure to easily split up posts by month, or even year.</p>

<p>Also, a few of you may have noticed, this script isn&rsquo;t terribly portable. In particular, the way we use <code>stat(1)</code> to include the date in the posts only works on linux. Another problem that commonly crops up is the reliance on <code>/bin/bash</code> to create portable shell scripts. Smallblog was developed under pdksh, and executes under <code>/bin/sh</code>, so many of the common bash-isms that can creep into shell scripts have been avoided (you may notice the use of <code>expr</code> rather than <code>let</code> for the inline math.) We&rsquo;ll discuss this more in <a href="http://mnetic.ch/blog/2013/08/18/smallblog_howto_part_2.md.html">part 2</a>.</p>

<p class="meta">tags: smallblog shell bash</p>
<br /></div>
<h3><a class="extra" href="/blog/archive.html">all posts</a></h3>

				<div class="footer">
					<div class="contact">
						<p>
							Aaron Fineman<br />
							github:
						</p>
					</div>
					<div class="contact">
						<p>
							<a href="mailto:abyxcos@mnetic.ch">abyxcos@mnetic.ch</a><br />
							<a href="https://github.com/abyxcos/">https://github.com/abyxcos/</a>
						</p>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>
